---
title: "Importing Spatial Data"
output: 
  html_document:
    toc: true
    toc_depth: 4
    toc_float:
      collapsed: false
      smooth_scroll: false
---

<style>
.title{
  display: none;
}
body {
  text-align: justify
}
.center {
  display: block;
  margin-left: auto;
  margin-right: auto;
}
table, th, td {
  border-collapse: collapse;
  align-self: center;
  padding-right: 10px;
  padding-left: 10px;
}
</style>

```{css, echo=FALSE}
.watch-out {
  color: black;
}
```

```{r setup, include=FALSE}
# use rmarkdown::render_site(envir = knitr::knit_global())
knitr::opts_chunk$set(highlight = TRUE, echo = TRUE)
```

<br>


# Working with VoltRon objects

In this tutorial, we will cover some of the fundemantel built-in functions of VoltRon to manage data, images and spatial information of assays.

```{r eval = FALSE, class.source="watch-out"}
data("visium_data")
data("melc_data")
```

<br>

## Sample Metadata

The sample metadata is a summarized data frame which provides informations on assays, layers and sample (tissue blocks) included in the VoltRon object. You can use the **SampleMetadata** function to call this table. The row names are the unique assay IDs, following assay types (e.g. Visium), layer name and Sample (typicall tissue block with multiple layers and assays).

```{r eval = FALSE, class.source="watch-out"}
SampleMetadata(visium_data)
```

```
        Assay    Layer    Sample
Assay1 Visium Section1 Anterior1
```

<br>

## Metadata

The **Metadata** function calls the metadata table of the main assay type (see [vrMainAssay](#assays)).

```{r eval = FALSE, class.source="watch-out"}
Metadata(visium_data)
```

```
                          Count  Assay    Layer    Sample
AAAGGCTCTCGCGCCG-1_Assay1 39690 Visium Section1 Anterior1
AAATGGCCCGTGCCCT-1_Assay1 33516 Visium Section1 Anterior1
AAATTACACGACTCTG-1_Assay1 12250 Visium Section1 Anterior1
AAGACATACGTGGTTT-1_Assay1 31821 Visium Section1 Anterior1
ACCTACTATAAATCTA-1_Assay1 41387 Visium Section1 Anterior1
ACGCGGGCCAAGGACA-1_Assay1 48003 Visium Section1 Anterior1
```

<br>

You can also specify the assay ID or the assay type to call metadata of a subset of spatial points.

```{r eval = FALSE, class.source="watch-out"}
Metadata(visium_data, assay = "Visium")
Metadata(visium_data, assay = "Assay1")
```

```
                          Count  Assay    Layer    Sample
AAAGGCTCTCGCGCCG-1_Assay1 39690 Visium Section1 Anterior1
AAATGGCCCGTGCCCT-1_Assay1 33516 Visium Section1 Anterior1
AAATTACACGACTCTG-1_Assay1 12250 Visium Section1 Anterior1
AAGACATACGTGGTTT-1_Assay1 31821 Visium Section1 Anterior1
ACCTACTATAAATCTA-1_Assay1 41387 Visium Section1 Anterior1
ACGCGGGCCAAGGACA-1_Assay1 48003 Visium Section1 Anterior1
```

<br>

The **type** argument returns all spatial points of a given spatial point type (ROI, spot, cell, molecule or tile).

```{r eval = FALSE, class.source="watch-out"}
Metadata(visium_data, type = "spot")
```

```
                          Count  Assay    Layer    Sample
AAAGGCTCTCGCGCCG-1_Assay1 39690 Visium Section1 Anterior1
AAATGGCCCGTGCCCT-1_Assay1 33516 Visium Section1 Anterior1
AAATTACACGACTCTG-1_Assay1 12250 Visium Section1 Anterior1
AAGACATACGTGGTTT-1_Assay1 31821 Visium Section1 Anterior1
ACCTACTATAAATCTA-1_Assay1 41387 Visium Section1 Anterior1
ACGCGGGCCAAGGACA-1_Assay1 48003 Visium Section1 Anterior1
```

<br>

If the type argument is specified as **all**. Then this would return the VoltRon Metadata Object (vrMetadata)

```{r eval = FALSE, class.source="watch-out"}
Metadata(visium_data, type = "all")
```

```
VoltRon Metadata Object 
This object includes: 
   100 spots
```

<br>

## Coordinates and Segments

The **vrCoordinates** function is used to call the centroids of spots, cells and all other spatial points types with VoltRon objects. 

```{r eval = FALSE, class.source="watch-out"}
vrCoordinates(visium_data)
```

```
                                 x        y
AAAGGCTCTCGCGCCG-1_Assay1 271.9105 183.1497
AAATGGCCCGTGCCCT-1_Assay1 136.8330 220.2237
AAATTACACGACTCTG-1_Assay1 382.0482 436.6781
AAGACATACGTGGTTT-1_Assay1 481.5491 102.7539
ACCTACTATAAATCTA-1_Assay1 282.5473 102.7539
ACGCGGGCCAAGGACA-1_Assay1 296.7470 313.0120
```

<br>

You can also specify the assay ID or the assay type to call coordinates of a subset of spatial points.

```{r eval = FALSE, class.source="watch-out"}
vrCoordinates(visium_data, assay = "Visium")
vrCoordinates(visium_data, assay = "Assay1")
```

```
                                 x        y
AAAGGCTCTCGCGCCG-1_Assay1 271.9105 183.1497
AAATGGCCCGTGCCCT-1_Assay1 136.8330 220.2237
AAATTACACGACTCTG-1_Assay1 382.0482 436.6781
AAGACATACGTGGTTT-1_Assay1 481.5491 102.7539
ACCTACTATAAATCTA-1_Assay1 282.5473 102.7539
ACGCGGGCCAAGGACA-1_Assay1 296.7470 313.0120
```

<br>

Each assay a VoltRon object may incorporate indefinite number of coordinate systems. One can look for these coordinate systems using the **vrMainImage** function, and select one of systems to call coordinates (see [vrMainImage](#image))

```{r eval = FALSE, class.source="watch-out"}
vrCoordinates(visium_data, image_name = "H&E")
```

```
                                 x        y
AAAGGCTCTCGCGCCG-1_Assay1 271.9105 183.1497
AAATGGCCCGTGCCCT-1_Assay1 136.8330 220.2237
AAATTACACGACTCTG-1_Assay1 382.0482 436.6781
AAGACATACGTGGTTT-1_Assay1 481.5491 102.7539
ACCTACTATAAATCTA-1_Assay1 282.5473 102.7539
ACGCGGGCCAAGGACA-1_Assay1 296.7470 313.0120
```

The **reg** option in the **vrCoordinates** function looks for a registered version of the main coordinate system and returns its coordinates (if there is any).

```{r eval = FALSE, class.source="watch-out"}
vrCoordinates(visium_data, image_name = "H&E", reg = TRUE)
```

```
                                 x        y
AAAGGCTCTCGCGCCG-1_Assay1 271.9105 183.1497
AAATGGCCCGTGCCCT-1_Assay1 136.8330 220.2237
AAATTACACGACTCTG-1_Assay1 382.0482 436.6781
AAGACATACGTGGTTT-1_Assay1 481.5491 102.7539
ACCTACTATAAATCTA-1_Assay1 282.5473 102.7539
ACGCGGGCCAAGGACA-1_Assay1 296.7470 313.0120
```

<br>

The arguements of the **vrSegments** functions are idential to vrCoordinates and return a list of polygon corners associated with the coordinate system of the coordinates. 

```{r eval = FALSE, class.source="watch-out"}
vrSegments(xenium_data)
vrSegments(visium_data, assay = "Visium")
vrSegments(visium_data, assay = "Assay1")
vrSegments(visium_data, image_name = "H&E")
vrSegments(visium_data, image_name = "H&E", reg = TRUE)
```

```
$`77197_Assay1`
# A tibble: 13 × 3
   cell_id     x     y
     <int> <dbl> <dbl>
 1   77197  490.  379.
 2   77197  487   378.
 3   77197  486.  373.
 4   77197  485.  366.
 5   77197  492.  364.
 6   77197  496.  360.
 7   77197  504.  354.
 8   77197  505.  354.
 9   77197  505   356.
10   77197  500.  366.
11   77197  492.  374.
12   77197  490.  379.
13   77197  490.  379.

$`77200_Assay1`
# A tibble: 13 × 3
   cell_id     x     y
     <int> <dbl> <dbl>
 1   77200  493.  383.
 2   77200  490.  380.
 3   77200  491.  376.
 4   77200  493.  374.
 5   77200  500.  366.
 6   77200  505   356.
 7   77200  510.  361.
 8   77200  510.  366.
 9   77200  509.  369.
10   77200  505.  372.
11   77200  502.  376.
12   77200  498   379.
13   77200  493.  383.
```

<br>

## Images {#image}

```{r eval = FALSE, class.source="watch-out"}
vrImageNames(visium_data)
```

```
[1] "H&E"
```

<br>

```{r eval = FALSE, class.source="watch-out"}
vrMainImage(visium_data)
```

```
   Assay Image
1 Assay1   H&E
```

<br>

```{r eval = FALSE, class.source="watch-out"}
vrImages(visium_data)
```

<img width="50%" height="50%" src="https://bimsbstatic.mdc-berlin.de/landthaler/VoltRon/Package/images/voltronobjects_HE.png" class="center">

<br>

```{r eval = FALSE, class.source="watch-out"}
vrImageChannelNames(melc_data)
```

```
   Assay Image  Channels
1 Assay1  MELC DAPI,CD45
```

```{r eval = FALSE, class.source="watch-out"}
vrImages(melc_data, name = "MELC", channel = "DAPI")
```

<img width="50%" height="50%" src="https://bimsbstatic.mdc-berlin.de/landthaler/VoltRon/Package/images/importdata_DAPI.png" class="center">

<br>

```{r eval = FALSE, class.source="watch-out"}
vrMainImage(melc_data, assay = "Assay1") <- c("MELC", "CD45")
vrImages(melc_data)
```

<img width="50%" height="50%" src="https://bimsbstatic.mdc-berlin.de/landthaler/VoltRon/Package/images/importdata_CD45.png" class="center">

<br>

```{r eval = FALSE, class.source="watch-out"}
melc_data <- combineChannels(melc_data, 
                             channels = c("DAPI", "CD45"), colors = c("grey", "green"), 
                             channel_key = "combined")
```

```{r eval = FALSE, class.source="watch-out"}
vrImageChannelNames(melc_data)
```

```{r eval = FALSE, class.source="watch-out"}
vrImages(melc_data, channel = "combined")
```

<br>

## Feature Matrix (Data)

```{r eval = FALSE, class.source="watch-out"}
vrData(visium_data)[3:8,3:5]
```

```
        AAATTACACGACTCTG-1_Assay1 AAGACATACGTGGTTT-1_Assay1 ACCTACTATAAATCTA-1_Assay1
Gm19938                         0                         0                         0
Gm37381                         0                         0                         0
Rp1                             0                         0                         0
Sox17                           0                         1                         1
Gm37587                         0                         0                         0
Gm37323                         0                         0                         0
```

```{r eval = FALSE, class.source="watch-out"}
vrData(visium_data, norm = TRUE)[3:8,3:5]
```

```
        AAATTACACGACTCTG-1_Assay1 AAGACATACGTGGTTT-1_Assay1 ACCTACTATAAATCTA-1_Assay1
Gm19938                         0                 0.0000000                 0.0000000
Gm37381                         0                 0.0000000                 0.0000000
Rp1                             0                 0.0000000                 0.0000000
Sox17                           0                 0.2732722                 0.2164184
Gm37587                         0                 0.0000000                 0.0000000
Gm37323                         0                 0.0000000                 0.0000000
```

<br>

## Assays {#assays}

The default (or main) assay of the VoltRon object is typically shown when printed (next to the assay name says "main" in paranthesis)

```{r eval = FALSE, class.source="watch-out"}
melc_data
```

```
VoltRon Object 
control_case_3: 
  Layers: Section1 
Assays: MELC(Main) 
```

<br>

You can also call/get the name of the default (or main) using the **vrMainAssay** function

```{r eval = FALSE, class.source="watch-out"}
vrMainAssay(melc_data)
```

```
[1] "MELC"
```

<br>

You can also set the main assay yourself, but only the assay types given in the **Assay** column of **SampleMetadata(object)**.

```{r eval = FALSE, class.source="watch-out"}
SampleMetadata(melc_data)
```

```
       Assay    Layer         Sample
Assay1  MELC Section1 control_case_3
```

```{r eval = FALSE, class.source="watch-out"}
vrMainAssay(melc_data) <- "MELC"
```

<br>

You can also get the assay IDs associated with the main assay using **vrAssayNames** function. 

```{r eval = FALSE, class.source="watch-out"}
vrAssayNames(melc_data)
```

```
[1] "Assay1"
```

<br>

The assay type can be provided with the **assay** arguement to get type specific assay IDs

```{r eval = FALSE, class.source="watch-out"}
vrAssayNames(melc_data, assay = "MELC")
```

```
[1] "Assay1"
```
