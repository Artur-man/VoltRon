---
title: "ondisk"
output: 
  html_document:
    toc: true
    toc_float:
      collapsed: false
      smooth_scroll: false
---

<style>
.title{
  display: none;
}
body {
  text-align: justify
}
.center {
  display: block;
  margin-left: auto;
  margin-right: auto;
}
</style>

```{css, echo=FALSE}
.watch-out {
  color: black;
}
```

```{r setup, include=FALSE}
# use rmarkdown::render_site(envir = knitr::knit_global())
knitr::opts_chunk$set(highlight = TRUE, echo = TRUE)
```

<br>

## Import VisiumHD Data

We first have to download some packages that are necessary to import datasets from `.parquet` and `.h5` files from the VisiumHD data.

```{r class.source="watch-out", eval = FALSE}
library(arrow)
library(hdf5r)
```

We use the `importVisiumHD` function to start analyzing the data

```{r class.source="watch-out", eval = FALSE}
hddata <- importVisiumHD(dir.path = "VisiumHD/outs/", 
                         bin.size = "8", 
                         resolution_level = "hires")
```

<br>

## OnDisk storage

We use `BPCells` and `ImageArray` functions to accelerate operations of feature matrices and images.

```{r class.source="watch-out", eval = FALSE}
library(BPCells)
library(ImageArray)
```

You can download these package from

```{r class.source="watch-out", eval = FALSE}
devtools::install_github("bnprks/BPCells/r")
devtools::install_github("BIMSBbioinfo/ImageArray")
```

We can now save the VoltRon object to disk.

```{r class.source="watch-out", eval = FALSE}
hddata <- saveVoltRon(hddata, format = "HDF5VoltRon", output = "data/OnDisk/VisiumHD")
```

If you want you can load the VoltRon object from the same container.

```{r class.source="watch-out", eval = FALSE}
hddata <- loadVoltRon("data/OnDisk/VisiumHD/")
```

Processing of the data is quick.

```{r class.source="watch-out", eval = FALSE}
hddata <- subset(hddata, Count > 10)
hddata <- normalizeData(hddata, sizefactor = 10000)
hddata <- getFeatures(hddata, n = 3000)
selected_features <- getVariableFeatures(hddata)
hddata <- getPCA(hddata, features = selected_features, dims = 30)
hddata <- getUMAP(hddata, dims = 1:30)
# hddata <- saveVoltRon(hddata, format = "HDF5VoltRon", output = "data/OnDisk/VisiumHD")
```

Visualization

```{r class.source="watch-out", eval = FALSE}
vrSpatialFeaturePlot(hddata, features = "Nrgn")
```