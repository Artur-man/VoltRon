---
title: "Cell/Spot Analysis"
output: 
  html_document:
    toc: true
    toc_float:
      collapsed: false
      smooth_scroll: false
---

<style>
body {
  text-align: justify
}
.center {
  display: block;
  margin-left: auto;
  margin-right: auto;
}
</style>

```{css, echo=FALSE}
.watch-out {
  color: black;
}
```

```{r setup, include=FALSE}
# use rmarkdown::render_site(envir = knitr::knit_global())
knitr::opts_chunk$set(highlight = TRUE, echo = TRUE)
```

<br>

# Downstream analysis on Cells

VoltRon is also an end-to-end spatial data analysis package which supports investigating spatial points in single cell resolution. VoltRon includes some essential built-in functions capable to filtering, processing and clustering as well as visualizing datasets on both spatial and embeddings domains. 

In this use case, we analyzed cells segmented from microscopy images of **control and COVID-19 lung tissues** of donors categorized based on disease durations (control, acute and prolonged). Each image is associated with one of few field of views (FOVs) of a single tissue section of a donor. See [GSE190732](https://www.ncbi.nlm.nih.gov/geo/query/acc.cgi?acc=GSE190732) for more information.  

We analyze cells characterized by multi-epitope ligand cartography (MELC) with a panel of 44 parameters. We use the already segmented cells which 42 protein expression features mapped on these cells. 

We first import the protein intensities, metadata and coordinates associated with segmented cells across FOVs of samples.

```{r eval = FALSE, class.source="watch-out"}
# csv file
IFdata <- read.csv("data/IFdata.csv")
data <- IFdata[,c(2:43)]
metadata <- IFdata[,c("disease_state", "object_id", "cluster", "Clusters", "SourceID", "BioSample", "FOV", "Sample")]
coords <- as.matrix(IFdata[,c("posX","posY")], rownames.force = TRUE)
```

<br>

## Building the VoltRon object

First, we normalize the data using the hyperbolic arcsine function with a scale argument of 0.2.

```{r eval = FALSE, class.source="watch-out", fig.align='center'}
data <- asinh(data/0.2)
```

Before the downsteam analysis on the MELC assays of cells across FOVs, we should separate each individual FOV/Section to a VoltRon object by using the **formVoltron** function where each object has only one section, then merge these sections using the sample of origins. We can also define assay names, types and sample (i.e. block) names of these assays. 

In addition, we flip the coordinates of these images and resize them. 

```{r eval = FALSE, class.source="watch-out", fig.align='center'}
vr_list <- list()
sample_metadata <- metadata %>% select(Sample, FOV, Section) %>% distinct()
for(i in 1:nrow(sample_metadata)){
  vrassay <- sample_metadata[i,]
  cells <- rownames(metadata)[metadata$Section == entry$Section]
  image <- magick::image_read(paste0("DAPI/", entry$BioSample, "/DAPI_", entry$FOV, ".tif"))
  vr_list[[entry$Sample]] <- formVoltRon(data = data[cells,], metadata = metadata[cells,], 
                                         image = image, coords = coords[cells,],
                                         main.assay = "MELC", assay.type = "cell", 
                                         sample_name = entry$Sample)
  vr_list[[entry$Sample]] <- flipCoords(vr_list[[entry$Sample]])
  vr_list[[entry$Sample]] <- resizeImage(vr_list[[entry$Sample]], size = 600)
}
```
